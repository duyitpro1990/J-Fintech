<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>J-Fintech Internet Banking</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 40px; background-color: #f0f2f5; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #1a202c; text-align: center; margin-bottom: 5px; }
        .balance-box { text-align: center; margin: 20px 0; padding: 15px; background: #ebf8f2; border-radius: 10px; color: #27ae60; }
        .balance-num { font-size: 2.5em; font-weight: bold; }
        
        button { width: 48%; padding: 12px; margin: 5px 1%; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-deposit { background: #2ecc71; } .btn-deposit:hover { background: #27ae60; }
        .btn-withdraw { background: #e74c3c; } .btn-withdraw:hover { background: #c0392b; }
        
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* Style cho b·∫£ng l·ªãch s·ª≠ */
        .history-list { list-style: none; padding: 0; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .history-item:last-child { border-bottom: none; }
        .plus { color: #27ae60; font-weight: bold; }
        .minus { color: #e74c3c; font-weight: bold; }
        .date { font-size: 0.8em; color: #7f8c8d; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>üè¶ J-Fintech</h1>
        <p style="text-align: center; color: #666;">Xin ch√†o: <strong id="owner">...</strong></p>
        
        <div class="balance-box">
            <div>S·ªë d∆∞ kh·∫£ d·ª•ng</div>
            <div class="balance-num" id="balance">0 ƒë</div>
        </div>

        <input type="number" id="amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn giao d·ªãch...">
        <div style="display: flex;">
            <button class="btn-deposit" onclick="handleTransaction('deposit')">N·∫°p ti·ªÅn (+)</button>
            <button class="btn-withdraw" onclick="handleTransaction('withdraw')">R√∫t ti·ªÅn (-)</button>
        </div>
    </div>

    <div class="card">
        <h3>üìú L·ªãch s·ª≠ giao d·ªãch</h3>
        <ul class="history-list" id="history-list">
            <li style="text-align: center; color: #999;">ƒêang t·∫£i d·ªØ li·ªáu...</li>
        </ul>
    </div>
</div>

<script>
    // D√πng API l·∫•y danh s√°ch (v√¨ n√≥ ch·ª©a lu√¥n c·∫£ transactions b√™n trong)
    const API_URL = "http://localhost:8080/accounts"; 
    let currentAccountId = null; // L∆∞u ID ƒë·ªÉ d√πng cho l·ªánh n·∫°p r√∫t

    // 1. H√†m t·∫£i d·ªØ li·ªáu (Load c·∫£ Info l·∫´n History)
    async function loadData() {
        try {
            let response = await fetch(API_URL);
            let list = await response.json();
            
            // L·∫•y ng∆∞·ªùi ƒë·∫ßu ti√™n trong danh s√°ch ƒë·ªÉ demo
            if (list.length === 0) return alert("Ch∆∞a c√≥ t√†i kho·∫£n n√†o!");
            let data = list[0]; 
            currentAccountId = data.id;

            // --- Hi·ªÉn th·ªã th√¥ng tin c∆° b·∫£n ---
            document.getElementById("owner").innerText = data.ownerName;
            document.getElementById("balance").innerText = formatMoney(data.balance);

            // --- Hi·ªÉn th·ªã l·ªãch s·ª≠ (Ph·∫ßn m·ªõi) ---
            renderHistory(data.transactions);

        } catch (e) {
            console.error(e);
            document.getElementById("history-list").innerHTML = "L·ªói k·∫øt n·ªëi Server!";
        }
    }

    // 2. H√†m v·∫Ω danh s√°ch l·ªãch s·ª≠ ra m√†n h√¨nh
    function renderHistory(transactions) {
        const listEl = document.getElementById("history-list");
        listEl.innerHTML = ""; // X√≥a c≈©

        if (!transactions || transactions.length === 0) {
            listEl.innerHTML = "<li style='text-align:center'>Ch∆∞a c√≥ giao d·ªãch n√†o</li>";
            return;
        }

        // S·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu (d·ª±a v√†o id ho·∫∑c timestamp)
        transactions.sort((a, b) => b.id - a.id);

        transactions.forEach(tx => {
            let isDeposit = tx.type === 'DEPOSIT';
            let colorClass = isDeposit ? 'plus' : 'minus';
            let sign = isDeposit ? '+' : '';
            let date = new Date(tx.timestamp).toLocaleString('vi-VN');

            let html = `
                <li class="history-item">
                    <div>
                        <div style="font-weight: 500;">${isDeposit ? 'N·∫°p ti·ªÅn' : 'R√∫t ti·ªÅn'}</div>
                        <div class="date">${date}</div>
                    </div>
                    <div class="${colorClass}">
                        ${sign} ${formatMoney(tx.amount)}
                    </div>
                </li>
            `;
            listEl.innerHTML += html;
        });
    }

    // 3. X·ª≠ l√Ω N·∫°p/R√∫t
    async function handleTransaction(type) {
        let amount = document.getElementById("amount").value;
        if (!amount) return alert("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn!");

        // G·ªçi API: /accounts/{id}/deposit
        let url = `http://localhost:8080/accounts/${currentAccountId}/${type}?amount=${amount}`;

        try {
            let response = await fetch(url, { method: 'PUT' });
            if (response.ok) {
                alert("Th√†nh c√¥ng!");
                document.getElementById("amount").value = ""; // X√≥a √¥ nh·∫≠p
                loadData(); // T·∫£i l·∫°i to√†n b·ªô d·ªØ li·ªáu (S·ªë d∆∞ + L·ªãch s·ª≠ m·ªõi)
            } else {
                let err = await response.json();
                alert("L·ªói: " + (err.message || "Th·∫•t b·∫°i"));
            }
        } catch (e) {
            alert("L·ªói h·ªá th·ªëng!");
        }
    }

    // Ti·ªán √≠ch: Format ti·ªÅn (100000 -> 100.000 ƒë)
    function formatMoney(num) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
    }

    // Ch·∫°y khi m·ªü web
    loadData();
</script>

</body>
</html>